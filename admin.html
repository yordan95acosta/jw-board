<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Panel - Congregación Valencia</title>
<style>
  body {
    font-family: sans-serif;
    max-width: 600px;
    margin: auto;
    padding: 2rem;
    background: #fffbe6;
  }
  h1, h2 {
    color: #b58900;
    text-align: center;
  }
  form {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  input, textarea, button {
    padding: 8px;
    font-size: 1rem;
  }
  button {
    background-color: #b58900;
    color: white;
    border: none;
    cursor: pointer;
  }
  #status, #loginStatus {
    margin-top: 1rem;
    font-weight: bold;
    text-align: center;
  }
  #logoutBtn {
    margin-bottom: 20px;
    background-color: #a67c00;
  }
  .announcement-card {
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 6px;
    background: #fffbe6;
  }
  .announcement-card img {
    max-width: 150px;
    display: block;
    margin-bottom: 8px;
  }
  .announcement-card button {
    background: #b58900;
    margin-top: 10px;
    border-radius: 4px;
    padding: 6px 12px;
    cursor: pointer;
  }
</style>
</head>
<body>
<h1>Admin Panel - Congregación Valencia</h1>

<div id="loginDiv">
  <h2>Please Log In</h2>
  <form id="loginForm">
    <label>Email:</label>
    <input type="email" id="loginEmail" required />
    <label>Password:</label>
    <input type="password" id="loginPassword" required />
    <button type="submit">Login</button>
  </form>
  <div id="loginStatus"></div>
</div>

<div id="uploadDiv" style="display:none;">
  <button id="logoutBtn">Logout</button>
  <form id="announcementForm">
    <label>Title:</label>
    <input type="text" id="title" required />
    <label>Description:</label>
    <textarea id="description"></textarea>
    <label>File (PDF or Image):</label>
    <input type="file" id="fileInput" accept=".pdf,image/*" required />
    <button type="submit">Upload Announcement</button>
  </form>
  <div id="status"></div>

  <h2>Existing Announcements</h2>
  <div id="announcementsContainer"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDJOuwebgrENgfgUrkziFnnNIwvh4PRq9Q",
    authDomain: "jwboard-2a83a.firebaseapp.com",
    projectId: "jwboard-2a83a",
    storageBucket: "jwboard-2a83a.appspot.com",
    messagingSenderId: "221707565673",
    appId: "1:221707565673:web:57309faa326e8508d840f8"
  };

  const cloudName = "dgx8qpq0x";
  const uploadPreset = "unsigned_upload";

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // Elements
  const loginDiv = document.getElementById("loginDiv");
  const uploadDiv = document.getElementById("uploadDiv");
  const loginForm = document.getElementById("loginForm");
  const logoutBtn = document.getElementById("logoutBtn");
  const announcementForm = document.getElementById("announcementForm");
  const statusDiv = document.getElementById("status");
  const loginStatusDiv = document.getElementById("loginStatus");
  const announcementsContainer = document.getElementById("announcementsContainer");

  // Listen for auth state
  auth.onAuthStateChanged(user => {
    if (user) {
      loginDiv.style.display = "none";
      uploadDiv.style.display = "block";
      loginStatusDiv.textContent = "";
      loadAndRenderAnnouncements();
    } else {
      loginDiv.style.display = "block";
      uploadDiv.style.display = "none";
      loginStatusDiv.textContent = "";
      statusDiv.textContent = "";
      announcementsContainer.innerHTML = "";
    }
  });

  // Login form submit
  loginForm.addEventListener("submit", async e => {
    e.preventDefault();
    loginStatusDiv.textContent = "Logging in...";
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value;
    try {
      await auth.signInWithEmailAndPassword(email, password);
      loginStatusDiv.textContent = "Logged in!";
      loginForm.reset();
    } catch (error) {
      loginStatusDiv.textContent = `Login failed: ${error.message}`;
    }
  });

  // Logout button
  logoutBtn.addEventListener("click", () => {
    auth.signOut();
  });

  // Upload announcement
  announcementForm.addEventListener("submit", async e => {
    e.preventDefault();
    statusDiv.textContent = "";

    const title = document.getElementById("title").value.trim();
    const description = document.getElementById("description").value.trim();
    const fileInput = document.getElementById("fileInput");
    const file = fileInput.files[0];

    if (!file) {
      statusDiv.textContent = "Please select a file.";
      return;
    }

    statusDiv.textContent = "Uploading file to Cloudinary...";

    try {
      // Upload to Cloudinary
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", uploadPreset);

      const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
        method: "POST",
        body: formData
      });

      const data = await response.json();

      if (!data.secure_url) throw new Error("Cloudinary upload failed.");

      // Save to Firestore
      await db.collection("announcements").add({
        title,
        description,
        fileUrl: data.secure_url,
        fileName: file.name,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      statusDiv.textContent = "Announcement uploaded successfully!";
      announcementForm.reset();
      loadAndRenderAnnouncements(); // Refresh list after upload
    } catch (err) {
      statusDiv.textContent = `Upload failed: ${err.message}`;
      console.error(err);
    }
  });

  // Load and display announcements with delete buttons
  async function loadAndRenderAnnouncements() {
    announcementsContainer.innerHTML = "<p>Loading announcements...</p>";
    try {
      const snapshot = await db.collection("announcements").orderBy("timestamp", "desc").get();

      if (snapshot.empty) {
        announcementsContainer.innerHTML = "<p>No announcements yet.</p>";
        return;
      }

      announcementsContainer.innerHTML = "";

      snapshot.forEach(doc => {
        const data = doc.data();
        const docId = doc.id;

        const card = document.createElement("div");
        card.className = "announcement-card";

        const titleEl = document.createElement("h3");
        titleEl.textContent = data.title || "(No title)";
        card.appendChild(titleEl);

        if (data.description) {
          const descEl = document.createElement("p");
          descEl.textContent = data.description;
          card.appendChild(descEl);
        }

        if (data.fileUrl) {
          if (/\.(jpg|jpeg|png|gif|webp)$/i.test(data.fileUrl)) {
            const img = document.createElement("img");
            img.src = data.fileUrl;
            img.alt = data.title || "Announcement image";
            card.appendChild(img);
          } else {
            const link = document.createElement("a");
            link.href = data.fileUrl;
            link.target = "_blank";
            link.rel = "noopener noreferrer";
            link.textContent = "View Document";
            card.appendChild(link);
          }
        }

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.addEventListener("click", async () => {
          if (confirm(`Are you sure you want to delete "${data.title}"? This action cannot be undone.`)) {
            try {
              await db.collection("announcements").doc(docId).delete();
              alert("Announcement deleted.");
              loadAndRenderAnnouncements();
            } catch (err) {
              alert("Failed to delete: " + err.message);
            }
          }
        });
        card.appendChild(deleteBtn);

        announcementsContainer.appendChild(card);
      });
    } catch (error) {
      announcementsContainer.innerHTML = `<p style="color:red;">Failed to load announcements: ${error.message}</p>`;
      console.error(error);
    }
  }
</script>
</body>
</html>


